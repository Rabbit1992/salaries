# å·¥èµ„æŸ¥è¯¢ç³»ç»Ÿ - ä»£ç è´¨é‡ä¸å¯ç»´æŠ¤æ€§æ”¹è¿›å»ºè®®

## ğŸ‰ å½“å‰çŠ¶æ€

âœ… **é£ä¹¦APIæµ‹è¯•å…¨éƒ¨é€šè¿‡**
- ç”¨æˆ·è¡¨è®°å½•æ•°: 68æ¡
- å·¥èµ„è¡¨è®°å½•æ•°: 68æ¡
- æ‰€æœ‰APIåŠŸèƒ½æ­£å¸¸
- æƒé™é…ç½®å®Œæ•´

## ğŸ“Š é¡¹ç›®æ¶æ„åˆ†æ

### å½“å‰æ¶æ„ä¼˜åŠ¿
1. **æ¸…æ™°çš„å‰åç«¯åˆ†ç¦»**: Vercel Serverless Functions + é™æ€å‰ç«¯
2. **æ¨¡å—åŒ–è®¾è®¡**: ç™»å½•å’Œå·¥èµ„æŸ¥è¯¢åŠŸèƒ½ç‹¬ç«‹
3. **æ ‡å‡†åŒ–API**: RESTfulé£æ ¼çš„APIè®¾è®¡
4. **å“åº”å¼UI**: ç°ä»£åŒ–çš„ç”¨æˆ·ç•Œé¢

### æ¶æ„æ”¹è¿›å»ºè®®
1. **APIç»Ÿä¸€ç®¡ç†**: åˆ›å»ºç»Ÿä¸€çš„APIé…ç½®å’Œé”™è¯¯å¤„ç†
2. **æ•°æ®ç¼“å­˜ç­–ç•¥**: å‡å°‘é‡å¤çš„é£ä¹¦APIè°ƒç”¨
3. **è¯·æ±‚ä¼˜åŒ–**: æ‰¹é‡å¤„ç†å’Œåˆ†é¡µåŠ è½½

## ğŸ”§ ä»£ç è´¨é‡æ”¹è¿›å»ºè®®

### 1. å®‰å…¨æ€§å¢å¼º

#### å½“å‰é—®é¢˜
- æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
- ç¼ºå°‘è¯·æ±‚éªŒè¯å’Œé˜²æŠ¤

#### æ”¹è¿›æ–¹æ¡ˆ
```javascript
// ç¯å¢ƒå˜é‡é…ç½®
const config = {
  APP_ID: process.env.FEISHU_APP_ID,
  APP_SECRET: process.env.FEISHU_APP_SECRET,
  APP_TOKEN: process.env.FEISHU_APP_TOKEN,
  USER_TABLE_ID: process.env.FEISHU_USER_TABLE_ID,
  SALARY_TABLE_ID: process.env.FEISHU_SALARY_TABLE_ID
};

// è¯·æ±‚éªŒè¯ä¸­é—´ä»¶
function validateRequest(req) {
  // IPç™½åå•æ£€æŸ¥
  // è¯·æ±‚é¢‘ç‡é™åˆ¶
  // å‚æ•°éªŒè¯
}
```

### 2. é”™è¯¯å¤„ç†ä¼˜åŒ–

#### åˆ›å»ºç»Ÿä¸€é”™è¯¯å¤„ç†å™¨
```javascript
// api/utils/errorHandler.js
class APIError extends Error {
  constructor(message, code = 500, details = null) {
    super(message);
    this.code = code;
    this.details = details;
  }
}

function handleAPIError(error, res) {
  console.error('API Error:', error);
  
  if (error instanceof APIError) {
    return res.status(error.code).json({
      success: false,
      message: error.message,
      details: error.details
    });
  }
  
  return res.status(500).json({
    success: false,
    message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
  });
}
```

### 3. æ€§èƒ½ä¼˜åŒ–

#### ç¼“å­˜æœºåˆ¶
```javascript
// api/utils/cache.js
const cache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿ

function getCachedData(key) {
  const cached = cache.get(key);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data;
  }
  return null;
}

function setCachedData(key, data) {
  cache.set(key, {
    data,
    timestamp: Date.now()
  });
}
```

#### æ‰¹é‡æ•°æ®å¤„ç†
```javascript
// ä¼˜åŒ–å·¥èµ„æŸ¥è¯¢ - æ”¯æŒæ‰¹é‡å’Œåˆ†é¡µ
async function getSalariesOptimized(employeeId, options = {}) {
  const { page = 1, pageSize = 20, year, month } = options;
  
  // æ„å»ºæŸ¥è¯¢æ¡ä»¶
  const filter = {
    conjunction: 'and',
    conditions: [
      {
        field_name: 'å·¥å·',
        operator: 'is',
        value: [employeeId]
      }
    ]
  };
  
  if (year) {
    filter.conditions.push({
      field_name: 'å¹´æœˆ',
      operator: 'contains',
      value: [year]
    });
  }
  
  return await querySalaryRecords(filter, page, pageSize);
}
```

### 4. ä»£ç ç»“æ„æ”¹è¿›

#### åˆ›å»ºæœåŠ¡å±‚
```javascript
// api/services/feishuService.js
class FeishuService {
  constructor(config) {
    this.config = config;
    this.accessToken = null;
    this.tokenExpiry = null;
  }
  
  async getAccessToken() {
    if (this.accessToken && Date.now() < this.tokenExpiry) {
      return this.accessToken;
    }
    
    // è·å–æ–°token
    const response = await this.requestAccessToken();
    this.accessToken = response.tenant_access_token;
    this.tokenExpiry = Date.now() + (response.expire * 1000);
    
    return this.accessToken;
  }
  
  async queryRecords(tableId, filter = {}, pageSize = 100) {
    const token = await this.getAccessToken();
    // å®ç°è®°å½•æŸ¥è¯¢é€»è¾‘
  }
}
```

### 5. å‰ç«¯ä¼˜åŒ–

#### çŠ¶æ€ç®¡ç†
```javascript
// public/scripts/store.js
class AppStore {
  constructor() {
    this.state = {
      user: null,
      salaries: [],
      loading: false,
      error: null
    };
    this.listeners = [];
  }
  
  setState(newState) {
    this.state = { ...this.state, ...newState };
    this.listeners.forEach(listener => listener(this.state));
  }
  
  subscribe(listener) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter(l => l !== listener);
    };
  }
}
```

#### ç»„ä»¶åŒ–æ”¹è¿›
```javascript
// public/scripts/components/SalaryTable.js
class SalaryTable {
  constructor(container, store) {
    this.container = container;
    this.store = store;
    this.init();
  }
  
  init() {
    this.store.subscribe(state => {
      if (state.salaries) {
        this.render(state.salaries);
      }
    });
  }
  
  render(salaries) {
    // æ¸²æŸ“è¡¨æ ¼é€»è¾‘
    this.container.innerHTML = this.generateTableHTML(salaries);
  }
  
  generateTableHTML(salaries) {
    // ç”Ÿæˆè¡¨æ ¼HTML
  }
}
```

## ğŸ“ å¼€å‘è§„èŒƒå»ºè®®

### 1. ä»£ç è§„èŒƒ
```json
// .eslintrc.js
{
  "extends": ["eslint:recommended"],
  "rules": {
    "no-console": "warn",
    "no-unused-vars": "error",
    "prefer-const": "error",
    "no-var": "error"
  }
}
```

### 2. ç±»å‹æ£€æŸ¥
```javascript
// ä½¿ç”¨JSDocè¿›è¡Œç±»å‹æ³¨é‡Š
/**
 * æŸ¥è¯¢ç”¨æˆ·å·¥èµ„è®°å½•
 * @param {string} employeeId - å‘˜å·¥å·¥å·
 * @param {Object} options - æŸ¥è¯¢é€‰é¡¹
 * @param {number} [options.year] - å¹´ä»½
 * @param {number} [options.month] - æœˆä»½
 * @returns {Promise<Array>} å·¥èµ„è®°å½•æ•°ç»„
 */
async function getSalaries(employeeId, options = {}) {
  // å®ç°é€»è¾‘
}
```

### 3. æµ‹è¯•ç­–ç•¥
```javascript
// tests/api.test.js
const { expect } = require('chai');
const request = require('supertest');

describe('API Tests', () => {
  describe('POST /api/login', () => {
    it('should authenticate valid user', async () => {
      const response = await request(app)
        .post('/api/login')
        .send({ username: 'test', password: 'test' });
      
      expect(response.status).to.equal(200);
      expect(response.body.success).to.be.true;
    });
  });
});
```

## ğŸš€ éƒ¨ç½²å’Œç›‘æ§æ”¹è¿›

### 1. ç¯å¢ƒé…ç½®
```bash
# .env.example
FEISHU_APP_ID=your_app_id
FEISHU_APP_SECRET=your_app_secret
FEISHU_APP_TOKEN=your_app_token
FEISHU_USER_TABLE_ID=your_user_table_id
FEISHU_SALARY_TABLE_ID=your_salary_table_id
NODE_ENV=production
```

### 2. ç›‘æ§å’Œæ—¥å¿—
```javascript
// api/utils/logger.js
class Logger {
  static info(message, data = {}) {
    console.log(JSON.stringify({
      level: 'info',
      message,
      data,
      timestamp: new Date().toISOString()
    }));
  }
  
  static error(message, error = {}) {
    console.error(JSON.stringify({
      level: 'error',
      message,
      error: error.message || error,
      stack: error.stack,
      timestamp: new Date().toISOString()
    }));
  }
}
```

### 3. å¥åº·æ£€æŸ¥
```javascript
// api/health.js
export default async function handler(req, res) {
  try {
    // æ£€æŸ¥é£ä¹¦APIè¿æ¥
    const feishuStatus = await checkFeishuConnection();
    
    res.status(200).json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      services: {
        feishu: feishuStatus ? 'up' : 'down'
      }
    });
  } catch (error) {
    res.status(503).json({
      status: 'unhealthy',
      error: error.message
    });
  }
}
```

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ (ç«‹å³å®æ–½)
1. âœ… ç¯å¢ƒå˜é‡é…ç½®
2. âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
3. âœ… åŸºç¡€å®‰å…¨é˜²æŠ¤
4. âœ… æ—¥å¿—è®°å½•

### ä¸­ä¼˜å…ˆçº§ (è¿‘æœŸå®æ–½)
1. ğŸ”„ ç¼“å­˜æœºåˆ¶
2. ğŸ”„ æ€§èƒ½ä¼˜åŒ–
3. ğŸ”„ ä»£ç è§„èŒƒ
4. ğŸ”„ ç›‘æ§å‘Šè­¦

### ä½ä¼˜å…ˆçº§ (é•¿æœŸè§„åˆ’)
1. â³ å•å…ƒæµ‹è¯•
2. â³ è‡ªåŠ¨åŒ–éƒ¨ç½²
3. â³ é«˜çº§åŠŸèƒ½æ‰©å±•
4. â³ å¾®æœåŠ¡æ¶æ„

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³è¡ŒåŠ¨**: é…ç½®ç¯å¢ƒå˜é‡ï¼Œæå‡å®‰å…¨æ€§
2. **æœ¬å‘¨å†…**: å®æ–½é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
3. **æœ¬æœˆå†…**: æ·»åŠ ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–
4. **æŒç»­æ”¹è¿›**: å»ºç«‹ä»£ç å®¡æŸ¥å’Œæµ‹è¯•æµç¨‹

é€šè¿‡è¿™äº›æ”¹è¿›ï¼Œæ‚¨çš„å·¥èµ„æŸ¥è¯¢ç³»ç»Ÿå°†æ›´åŠ å®‰å…¨ã€ç¨³å®šã€é«˜æ•ˆå’Œæ˜“äºç»´æŠ¤ï¼